<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leads â€“ Bintech CRM</title>
  <link rel="stylesheet" href="styles.css" />
  <script>
  if (localStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

  <style>
    .btn {
      padding: 4px 8px;
      margin: 0 2px;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .edit-btn { background-color: #3498db; }
    .delete-btn { background-color: #e74c3c; }
    .export-btn { background-color: #2ecc71; }
    .import-btn { background-color: #f39c12; }
    form input, form select { margin: 4px; }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-brand">ðŸ”¹ Bintech CRM</div>
    <ul class="nav-links">
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="leads.html" class="active">Leads</a></li>
      <li><a href="deals.html">Deals</a></li>
      <li><a href="contacts.html">Contacts</a></li>
    </ul>
    <button class="dark-toggle" onclick="document.body.classList.toggle('dark-mode')">ðŸŒ™</button>
  </nav>

  <div class="layout">
    <aside class="sidebar">
      <ul>
        <li><a href="leads.html" class="active">Leads</a></li>
        <li><a href="deals.html">Deals</a></li>
        <li><a href="contacts.html">Contacts</a></li>
      </ul>
    </aside>

    <div class="container">
      <h1>Leads</h1>

      <form id="leadForm">
        <input type="text" id="leadName" placeholder="Lead Name" required />
        <input type="email" id="leadEmail" placeholder="Email" required />
        <input type="text" id="leadPhone" placeholder="Phone" required />
        <input type="text" id="leadStatus" placeholder="Status" required />
        <input type="text" id="customerName" placeholder="Customer Name" required />
        <input type="text" id="companyName" placeholder="Company Name" required />
        <select id="productBrand" required>
          <option value="">Select Brand</option>
          <option value="Matrix">Matrix</option>
          <option value="CPPlus">CPPlus</option>
          <option value="Asttecs">Asttecs</option>
          <option value="POS">POS</option>
          <option value="Marg">Marg</option>
          <option value="Ayzo">Ayzo</option>
        </select>
        <select id="category" required>
          <option value="">Select Category</option>
          <option value="IPVS">IPVS</option>
          <option value="Acta">Acta</option>
          <option value="Telecom">Telecom</option>
        </select>
        <input type="date" id="quotationDate" required />
        <input type="date" id="endDate" required />
        <button type="submit">Add Lead</button>
      </form>

      <div style="margin-top: 10px;">
        <button class="btn export-btn" onclick="downloadCSV()">Export CSV</button>
        <form id="importForm" enctype="multipart/form-data">
          <input type="file" id="csvFile" name="file" accept=".csv" style="display:none;" />
          <button class="btn import-btn" type="button" onclick="document.getElementById('csvFile').click()">Import CSV</button>
        </form>
      </div>

      <table>
        <thead>
          <tr>
            <th>Lead Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Status</th>
            <th>Customer</th>
            <th>Company</th>
            <th>Brand</th>
            <th>Category</th>
            <th>Quotation Date</th>
            <th>End Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="leadTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const leadForm = document.getElementById("leadForm");
    const leadTableBody = document.getElementById("leadTableBody");
    const csvFile = document.getElementById("csvFile");
    let editRow = null;
    let leads = [];

    function saveLeadsToStorage() {
      localStorage.setItem("bintechLeads", JSON.stringify(leads));
    }

    function loadLeadsFromStorage() {
      const stored = localStorage.getItem("bintechLeads");
      if (stored) {
        leads = JSON.parse(stored);
        leads.forEach(addRowToTable);
      }
    }

    function addRowToTable(lead, index) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${lead.name}</td>
        <td>${lead.email}</td>
        <td>${lead.phone}</td>
        <td>${lead.status}</td>
        <td>${lead.customer}</td>
        <td>${lead.company}</td>
        <td>${lead.brand}</td>
        <td>${lead.category}</td>
        <td>${lead.quotationDate}</td>
        <td>${lead.endDate}</td>
      `;
      row.appendChild(createActionsCell(row, index));
      leadTableBody.appendChild(row);
    }

    function createActionsCell(row, index) {
      const actionsCell = document.createElement("td");
      const editBtn = document.createElement("button");
      const deleteBtn = document.createElement("button");

      editBtn.textContent = "Edit";
      editBtn.className = "btn edit-btn";
      editBtn.onclick = () => {
        const lead = leads[index];
        document.getElementById("leadName").value = lead.name;
        document.getElementById("leadEmail").value = lead.email;
        document.getElementById("leadPhone").value = lead.phone;
        document.getElementById("leadStatus").value = lead.status;
        document.getElementById("customerName").value = lead.customer;
        document.getElementById("companyName").value = lead.company;
        document.getElementById("productBrand").value = lead.brand;
        document.getElementById("category").value = lead.category;
        document.getElementById("quotationDate").value = lead.quotationDate;
        document.getElementById("endDate").value = lead.endDate;
        editRow = index;
      };

      deleteBtn.textContent = "Delete";
      deleteBtn.className = "btn delete-btn";
      deleteBtn.onclick = () => {
        leads.splice(index, 1);
        saveLeadsToStorage();
        renderTable();
      };

      actionsCell.appendChild(editBtn);
      actionsCell.appendChild(deleteBtn);
      return actionsCell;
    }

    function renderTable() {
      leadTableBody.innerHTML = "";
      leads.forEach(addRowToTable);
    }

    leadForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const lead = {
        name: document.getElementById("leadName").value.trim(),
        email: document.getElementById("leadEmail").value.trim(),
        phone: document.getElementById("leadPhone").value.trim(),
        status: document.getElementById("leadStatus").value.trim(),
        customer: document.getElementById("customerName").value.trim(),
        company: document.getElementById("companyName").value.trim(),
        brand: document.getElementById("productBrand").value,
        category: document.getElementById("category").value,
        quotationDate: document.getElementById("quotationDate").value,
        endDate: document.getElementById("endDate").value
      };

      if (editRow !== null) {
        leads[editRow] = lead;
        editRow = null;
      } else {
        leads.push(lead);
      }

      saveLeadsToStorage();
      renderTable();
      leadForm.reset();
    });

    function downloadCSV() {
      if (leads.length === 1) {
        alert("No leads to export.");
        return;
      }

      const headers = [
        "Lead Name",
        "Email",
        "Phone",
        "Status",
        "Customer",
        "Company",
        "Brand",
        "Category",
        "Quotation Date",
        "End Date"
      ];

      const rows = leads.map(lead => [
        lead.name,
        lead.email,
        lead.phone,
        lead.status,
        lead.customer,
        lead.company,
        lead.brand,
        lead.category,
        lead.quotationDate,
        lead.endDate
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.map(value => `"${value}"`).join(","))
        .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "leads.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    csvFile.addEventListener("change", function () {
      const file = csvFile.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const rows = text.trim().split("\n").slice(1); // Skip header row
        for (let row of rows) {
          const values = row.split(",").map(v => v.replace(/(^"|"$)/g, ""));
          if (values.length === 10) {
            leads.push({
              name: values[0],
              email: values[1],
              phone: values[2],
              status: values[3],
              customer: values[4],
              company: values[5],
              brand: values[6],
              category: values[7],
              quotationDate: values[8],
              endDate: values[9]
            });
          }
        }
        saveLeadsToStorage();
        renderTable();
      };
      reader.readAsText(file);
      csvFile.value = "";
    });

    // Load leads on page load
    loadLeadsFromStorage();
  </script>

</body>
</html>
